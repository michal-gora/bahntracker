import asyncio
import json
import websockets
from pyproj import Transformer

WS_URL = "wss://api.geops.io/realtime-ws/v1/?key=5cc87b12d7c5370001c1d655112ec5c21e0f441792cfc2fafe3e7a1e"
transformer = Transformer.from_crs("EPSG:3857", "EPSG:4326", always_xy=True)

# Fasanenpark coordinates from earlier: 48.079710Â°N, 11.609378Â°E
FASANENPARK_LAT = 48.079710
FASANENPARK_LON = 11.609378
FASANENPARK_UIC = "8001963"

# Sample trajectory from train 6376
trajectory_coords = [
    [1302140, 6087656],
    [1301801, 6088081],
    [1301719, 6088171],
    [1301550, 6088402],
    [1301491, 6088501],
    [1301426, 6088626],
    [1301372, 6088746],
    [1301303, 6088919],
    [1301262, 6089034],
    [1301194, 6089262],
    [1300483, 6092010],
    [1300450, 6092118],
    [1300357, 6092459],
    [1299993, 6093883],
    [1298119, 6101100],
    [1298075, 6101245],
    [1297995, 6101470],
    [1297923, 6101644],
    [1297836, 6101828],
    [1297754, 6101987],
    [1297662, 6102147],
    [1297413, 6102527],
    [1297394, 6102563],
    [1297325, 6102648],
    [1297154, 6102840],
    [1297044, 6102955],
    [1296856, 6103133],
    [1296668, 6103291],
    [1290471, 6108257],
    [1290294, 6108412],
    [1290160, 6108552],
    [1290070, 6108662],
    [1289949, 6108838],
    [1289856, 6109006],
    [1289794, 6109140],
    [1289764, 6109217],
    [1289602, 6109704],
    [1289482, 6110093],
    [1289363, 6110483],
    [1289291, 6110739],
    [1289280, 6110811],
    [1289280, 6110898],
    [1289289, 6110960],
    [1289317, 6111061],
    [1289347, 6111131],
    [1289415, 6111239],
    [1290337, 6112461],
    [1290609, 6112830],
    [1292059, 6114763],
    [1292132, 6114887],
    [1292189, 6115006],
    [1292223, 6115091],
    [1292359, 6115489],
    [1292588, 6116229],
    [1292623, 6116401],
    [1292638, 6116521],
    [1292651, 6116830],
    [1292662, 6116959],
    [1292685, 6117712],
    [1292695, 6118072],
    [1292689, 6118158],
    [1292360, 6120104],
    [1292028, 6122066],
    [1292012, 6122146],
    [1291954, 6122369],
    [1291895, 6122553],
    [1291785, 6122843],
    [1291767, 6122924],
    [1291493, 6123566],
    [1291333, 6123915],
    [1291293, 6124020],
    [1291192, 6124347],
    [1291155, 6124447],
    [1290985, 6125022],
    [1290870, 6125363],
    [1290814, 6125554],
    [1290805, 6125600],
    [1290780, 6125802],
    [1290767, 6126028],
    [1290771, 6126164],
    [1290783, 6126265],
    [1290836, 6126602],
    [1290854, 6126709],
    [1290877, 6126861],
    [1290896, 6126973],
    [1290924, 6127065],
    [1290973, 6127160],
    [1291061, 6127275],
    [1291505, 6127772],
    [1291602, 6127859],
    [1291759, 6127975],
    [1291922, 6128128],
    [1291759, 6127975],
    [1291602, 6127859],
    [1291555, 6127832],
    [1291494, 6127808],
    [1291434, 6127794],
    [1291380, 6127788],
    [1291330, 6127785],
    [1291279, 6127787],
    [1291229, 6127797],
    [1291182, 6127814],
    [1291123, 6127844],
    [1291064, 6127888],
    [1290705, 6128212],
    [1290535, 6128374],
    [1290189, 6128708],
    [1290125, 6128763],
    [1290064, 6128804],
    [1290020, 6128827],
    [1289829, 6128899],
    [1289694, 6128976],
    [1289568, 6129068],
    [1289429, 6129212],
    [1289246, 6129377],
    [1289195, 6129413],
    [1289077, 6129470],
    [1288839, 6129564],
    [1288683, 6129652],
    [1288567, 6129701],
    [1288258, 6129805],
    [1288116, 6129870],
    [1288045, 6129894],
    [1287985, 6129908],
    [1287868, 6129924],
    [1287724, 6129960],
    [1287559, 6130027],
    [1287530, 6130044],
    [1287479, 6130092],
    [1287285, 6130204],
    [1287061, 6130310],
    [1286856, 6130387],
    [1286745, 6130418],
    [1286504, 6130502],
    [1286303, 6130552],
    [1286235, 6130558],
    [1286172, 6130555],
    [1286087, 6130539],
    [1285911, 6130498],
    [1285798, 6130485],
    [1285684, 6130485],
    [1285576, 6130495],
    [1285035, 6130561],
    [1284817, 6130577],
    [1284465, 6130615],
    [1284240, 6130623],
    [1283786, 6130632],
    [1283594, 6130626],
    [1282316, 6130771],
    [1282076, 6130769],
    [1281703, 6130746],
    [1281577, 6130747],
    [1281479, 6130754],
    [1280969, 6130831],
    [1280587, 6130902],
    [1279964, 6130988],
    [1279828, 6131014],
    [1279396, 6131110],
    [1279323, 6131122],
    [1279223, 6131129],
    [1278892, 6131127],
    [1278810, 6131131],
    [1278770, 6131129],
    [1277215, 6131304],
    [1277058, 6131327],
    [1276889, 6131369],
    [1276790, 6131404],
    [1276708, 6131440],
    [1276517, 6131533],
    [1276216, 6131697],
    [1275918, 6131839],
    [1275662, 6131960],
    [1275489, 6132057],
    [1275283, 6132148],
    [1275101, 6132210],
    [1274763, 6132285],
    [1274594, 6132348],
    [1274504, 6132390],
    [1274390, 6132458],
    [1274307, 6132516],
    [1274224, 6132585],
    [1274167, 6132640],
    [1273751, 6133090],
    [1273544, 6133293],
    [1273322, 6133485],
    [1272659, 6134028],
    [1270027, 6136189],
    [1269729, 6136445],
    [1267956, 6137890],
    [1266130, 6139388],
    [1265116, 6140201],
    [1264756, 6140462],
    [1264623, 6140554],
    [1264339, 6140736],
    [1263983, 6140948],
    [1263581, 6141161],
    [1262970, 6141448],
    [1262734, 6141551],
    [1262488, 6141650],
    [1262214, 6141747],
    [1261858, 6141864],
    [1261699, 6141904],
    [1261495, 6141964],
    [1261339, 6142001],
    [1260693, 6142119],
    [1260314, 6142178],
    [1259971, 6142209],
    [1259797, 6142231],
    [1259486, 6142254],
    [1257967, 6142322],
    [1257349, 6142359],
    [1254216, 6142513],
    [1253736, 6142531],
    [1253227, 6142555],
    [1252969, 6142572],
    [1251888, 6142618],
    [1251384, 6142650],
    [1249965, 6142718],
    [1249212, 6142753],
    [1248897, 6142773],
    [1246445, 6142888],
    [1245173, 6142938],
    [1244403, 6142986],
    [1244117, 6143008]
]


async def get_station_timetable(ws, station_uic):
    """Get full timetable for a station"""
    command = f"GET timetable_{station_uic}"
    await ws.send(command)
    print(f"ðŸ“¡ Sent: {command}\n")
    
    messages = []
    try:
        async with asyncio.timeout(5):
            async for msg in ws:
                data = json.loads(msg)
                source = data.get('source', '')
                
                if source.startswith('timetable_'):
                    messages.append(data)
                    if len(messages) >= 3:  # Get first 3 trains
                        break
    except asyncio.TimeoutError:
        pass
    
    return messages


def haversine_distance(lat1, lon1, lat2, lon2):
    """Calculate distance in km between two points"""
    from math import radians, sin, cos, sqrt, atan2
    
    lat1, lon1, lat2, lon2 = map(radians, [lat1, lon1, lat2, lon2])
    dlat = lat2 - lat1
    dlon = lon2 - lon1
    
    a = sin(dlat/2)**2 + cos(lat1) * cos(lat2) * sin(dlon/2)**2
    c = 2 * atan2(sqrt(a), sqrt(1-a))
    
    return 6371 * c  # Earth radius in km


async def main():
    async with websockets.connect(WS_URL, max_size=10 * 1024 * 1024) as ws:
        print("ðŸ”Œ Connected to WebSocket\n")
        
        # 1. Get Fasanenpark timetable
        print("="*80)
        print("PART 1: FASANENPARK TIMETABLE (First 3 trains)")
        print("="*80 + "\n")
        
        timetable = await get_station_timetable(ws, FASANENPARK_UIC)
        for i, msg in enumerate(timetable, 1):
            print(f"--- Train {i} ---")
            print(json.dumps(msg, indent=2, ensure_ascii=False))
            print()
        
        # 2. Check if any trajectory points match Fasanenpark
        print("\n" + "="*80)
        print("PART 2: TRAJECTORY POINT MATCHING WITH FASANENPARK")
        print("="*80 + "\n")
        
        print(f"Fasanenpark coordinates: {FASANENPARK_LAT:.6f}Â°N, {FASANENPARK_LON:.6f}Â°E\n")
        print(f"Checking {len(trajectory_coords)} trajectory points...\n")
        
        matches = []
        for i, coord in enumerate(trajectory_coords):
            lon, lat = transformer.transform(coord[0], coord[1])
            distance = haversine_distance(FASANENPARK_LAT, FASANENPARK_LON, lat, lon)
            
            if distance < 0.5:  # Within 500m
                matches.append({
                    'index': i,
                    'lat': lat,
                    'lon': lon,
                    'distance_m': distance * 1000,
                    'epsg3857': coord
                })
        
        if matches:
            print(f"âœ… Found {len(matches)} trajectory point(s) near Fasanenpark:\n")
            for match in matches:
                print(f"  Point #{match['index']}:")
                print(f"    Lat/Lon: {match['lat']:.6f}Â°N, {match['lon']:.6f}Â°E")
                print(f"    EPSG:3857: {match['epsg3857']}")
                print(f"    Distance: {match['distance_m']:.1f}m from Fasanenpark")
                print(f"    Google Maps: https://www.google.com/maps?q={match['lat']},{match['lon']}")
                print()
        else:
            print("âŒ No trajectory points found within 500m of Fasanenpark")
            print("   (This trajectory might not pass through Fasanenpark)")
        
        print("\n" + "="*80)
        print("ANALYSIS COMPLETE")
        print("="*80)


if __name__ == "__main__":
    asyncio.run(main())
